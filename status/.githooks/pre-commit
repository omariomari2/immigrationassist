#!/bin/bash
# Pre-commit hook to scan for secrets
# Install: Copy to .git/hooks/pre-commit and make executable (chmod +x)

set -e

echo "üîç Scanning for potential secrets..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns to check
PATTERNS=(
    "API_KEY.*=.*[a-zA-Z0-9]"
    "api[_-]?key.*=.*[a-zA-Z0-9]"
    "password.*=.*[^\"']"
    "secret.*=.*[a-zA-Z0-9]"
    "token.*=.*[a-zA-Z0-9]"
    "private[_-]?key"
    "BEGIN.*PRIVATE KEY"
)

# Files to scan (staged files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úì No files to scan${NC}"
    exit 0
fi

FOUND_ISSUES=0

for file in $STAGED_FILES; do
    # Skip binary files and common non-source files
    if [[ "$file" =~ \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|zip|gz|exe|dll|so|dylib)$ ]]; then
        continue
    fi
    
    # Check if file exists and is readable
    if [ ! -f "$file" ]; then
        continue
    fi
    
    for pattern in "${PATTERNS[@]}"; do
        if git show :"$file" | grep -iE "$pattern" > /dev/null 2>&1; then
            echo -e "${RED}‚ö†Ô∏è  Potential secret found in $file matching: $pattern${NC}"
            FOUND_ISSUES=1
        fi
    done
done

# Check for .env files being committed
if echo "$STAGED_FILES" | grep -E "^\.env" > /dev/null; then
    echo -e "${RED}‚ùå ERROR: .env file(s) are staged for commit!${NC}"
    echo -e "${YELLOW}   Remove with: git reset HEAD .env*${NC}"
    FOUND_ISSUES=1
fi

# Check for large CSV files
LARGE_FILES=$(git diff --cached --name-only | xargs -I{} sh -c 'if [ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null || echo 0) -gt 1048576 ]; then echo "{}"; fi' 2>/dev/null || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES" | while read -r f; do echo "   - $f"; done
    echo -e "${YELLOW}   Ensure these are intended to be committed${NC}"
fi

if [ $FOUND_ISSUES -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå Commit blocked due to potential security issues${NC}"
    echo -e "${YELLOW}   If these are false positives, run: git commit --no-verify${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì No secrets detected${NC}"
exit 0
